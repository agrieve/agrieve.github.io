<!DOCTYPE html>
<html>
<head>
  <title>Clank Dashboard</title>
<style>
  html, body {
    border: 0;
    margin: 0;
    font-family: sans-serif;
  }
  .size-iframe {
    width:100%;
    height:424px;
    border:0;
  }
  .memory-iframe {
    width:90%; /* Set so that it doesn't scroll */
    height:calc(100vh - 20px); /* 20px of padding for some unknown reason */
    border:0;
  }
  .iframe-holder {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .branch {
    margin-top: 80px;
    font-size: 80pt;
    text-align: center;
  }
  #time_div {
    margin-top: 40px;
    font-size: 80pt;
    text-align: center;
  }
  #snippet_div {
    margin-top: 40px;
    font-size: 100pt;
    text-align: center;
  }
  #page1, #page2 {
    position : fixed;
    width:100%;
  }

</style>
</head>
<body tabindex=0 display:>
<div id=page1>
  <div class="iframe-holder">
<!-- broken:
    <iframe class="size-iframe" scrolling=no src="https://datastudio.google.com/embed/reporting/18HN5esOG3VZFxCbooSzbd_zUmviKDgC4/page/U58t"></iframe>
-->
    <div class="size-iframe iframe-holder">
       <img src="logo.png">
    </div>
  </div>
  <div class="branch">
    <span id=branch_name>M##</span> branch in <span style="color: red" id=days_span></span>
  </div>
  <div id=time_div></div>
  <div id=snippet_div style="display:none">ðŸ“œ Snippet Reminder ðŸ“œ</div>
</div>
<!-- broken:
<iframe id=page2 class="memory-iframe" scrolling=no src="https://datastudio.google.com/embed/reporting/1ywCS2zlmxUOzoe4o2zM06CStdNo3lUEC/page/zfFb"></iframe>
 -->
</body>
<script>
var MINUTES = 1000 * 60;
var MONDAY_HOLIDAYS = [
  new Date('Aug 1, 2022'),
  new Date('Sept 5, 2022'),
  new Date('Oct 10, 2022'),
  new Date('Dec 26, 2022'),
  ];

async function updateBranchInfo() {
  let schduleResponse = await fetch('https://chromiumdash.appspot.com/fetch_milestone_schedule?offset=-1&n=4');
  let scheduleJson = await schduleResponse.json();
  console.log(scheduleJson);
  let mstones = scheduleJson['mstones']
  var now = new Date();
  for (let mstone of mstones) {
    var then = new Date(mstone['branch_point']);
    var days = Math.ceil((then - now) / (60 * MINUTES * 24));
    if (days >= 0) {
      branch_name.textContent = 'M' + mstone['mstone'];
      days_span.textContent = days + ' days';
      break;
    }
  }
}

function checkFocus() {
  if (!document.activeElement) return;
  if (document.activeElement.tagName == 'IFRAME') {
    console.log('iframe has focus');
    document.body.focus()
  }
}
function refreshIframes() {
  var frames = document.getElementsByTagName('iframe');
  for (var i = 0; i < frames.length; ++i) {
    frames[i].src = frames[i].src;
  }
}
function reloadPage() {
  location.href = location.href;
}
function updateTime() {
  var now = new Date();
  time_div.textContent = now.toLocaleTimeString().replace(/:\d\d /, ' ');
  var showSnippets = now.getDay() == 1;
  if (now.getDay() == 5) {
    // Friday before long weekend.
    var nextMonday = new Date(Date.now() + 3*24*60*MINUTES)
    for (var holiday of MONDAY_HOLIDAYS) {
      if (holiday.getYear() == nextMonday.getYear() &&
          holiday.getMonth() == nextMonday.getMonth() &&
          holiday.getDate() == nextMonday.getDate()) {
        showSnippets = true;
      }
    }
  }
  snippet_div.style.display = showSnippets ? '' : 'none';
}
curVisibile = false;
function swapDivs() {
  curVisibile = !curVisibile;

  if (curVisibile) {
    page1.style.visibility = 'hidden'
    page2.style.visibility = ''
  } else {
    page1.style.visibility = ''
    page2.style.visibility = 'hidden'
  }
}
updateBranchInfo();
updateTime();
setInterval(checkFocus, 1000);
setInterval(refreshIframes, 10 * MINUTES);
setInterval(reloadPage, 60 * MINUTES * 24);
setInterval(updateTime, 1000);

/*
var page = new URLSearchParams(window.location.search).get('page');
if (page) {
  if (page == '1') {
    swapDivs();
  }
} else {
  setInterval(swapDivs, MINUTES / 3);
}*/

</script>
</html>
